<script type="text/javascript">
	/* Loading themeTester */
	//var loadingEl = dojo.byId("loaderInner");
	//loadingEl.innerHTML += "<br />* Menu widgets - dijit.Menu";
	
	selectedRoutineNames = [];

	
	dojo.ready( function() {
		/* delete cookie */
		//if (document.URL == "http://127.0.0.1:8000/index/" || document.URL == "http://127.0.0.1:8000/index/?clear="){
		//	dojo.cookie("nameList", null, {path: '/', expire: -1});
		//	console.log("initial cookie:", dojo.cookie("nameList"));
		//}
		
		
		// this is just a list of 'official' dijit themes, you can use
		// ?theme=String for 'un-supported' themes, too. (eg: yours)
		
		var availableThemes = [
			{
				theme:"1",
				author:"Sa-Lin Cheng Bernstein",
				baseUri:"../themes/"
			},
			{
				theme:"2",
				author:"Javed Hossain",
				baseUri:"../themes/"
			},
			{
				theme:"3",
				author:"Elizabeth R. Jessup",
				baseUri:"../themes/"
			},
			{
				theme:"4",
				author:"Boyana Norris",
				baseUri:"../themes/"
			}
		];
		var holder = dojo.byId('themeData');
		var tmpString='';
		dojo.forEach(availableThemes, function(theme) {
			tmpString += '<a href="?theme='+theme.theme+'">'+
			theme.theme+'</'+'a>: '+theme.author+' <br>';
		});
		holder.innerHTML = tmpString;
		
		
		
		
		/* for parser time info */
		var start = new Date().getTime();
		dojo.parser.parse(dojo.byId('container'));
		console.info("Total parse time: " + (new Date().getTime() - start) + "ms");
					
		//dojo.byId('loaderInner').innerHTML += " done.";
		
		setTimeout( function hideLoader() {
			var loader = dojo.byId('loader');
			dojo.fadeOut({
				node: loader,
				duration:500,
				onEnd: function() {
					loader.style.display = "none";
				}
			}).play();
		}, 250);
		
		
		
		var strayGlobals = [];
		for(var i in window) {
			if(!window.$$globalList[i]) {
				strayGlobals.push(i);
			}
		}
		if(strayGlobals.length) {
			console.warn("Stray globals: "+strayGlobals.join(", "));
		}
		
		/* create dnd Sources */
		var source1 = new dojo.dnd.Source("routineListNode");
		var source2 = new dojo.dnd.Target("selectedListNode");		

		/* update Django session for selected routines through javascript*/
		//var nameObj = [];
		dojo.connect( source1, "onDndDrop", 
			function(source, nodes, copy, target){
				//console.log("cookie predrop:", dojo.cookie("nameList"));
				var cookieToArray = [];
				if (dojo.cookie("nameList") != null){
					cookieToArray = dojo.cookie("nameList").split(',');
				}
				
				for( i=0; i < nodes.length; i++){
					item = this.getItem(nodes[i].id);
					liId = nodes[i].id;
					//routineData = item.data;
					//nameObj.push(liId);
					//dojo.cookie(liId, routineData, {path: '/'});					
					
					var detail = dojo.attr(dojo.byId(liId), "detail")
					var precision = detail.split("_")[0];
					var routineName = detail.split("_")[1];
					var matrixType = detail.split("_")[2];
					var storageType = detail.split("_")[3];
					var idn = detail.split("_")[4];
					var url = detail.split("_")[5]+"_8f.html";

					//if(routineExists(precision+routineName,allRoutines_session)){
					//	alert("Routine already selected!");
					//}

					allRoutines_session.push(precision+routineName);
					
					//dojo.cookie(liId, detail);
					//alert(precision+routineName);
					
					/* pass "routineData" to ajax.py for test */
					//Dajaxice.Driver.test(Dajax.process, {'data': routineData});
					
					/* pass "detail" to views.py via ajax to update request.session['selectedRoutines'] */
					dojo.xhrPost( {
						url: "/search/update_session/",
						content: {
							precision: precision,
							routineName: routineName,
							matrixType: matrixType,
							storageType: storageType,
							idn: idn,
							url: url,							
							checkState: "checked"
							},
						load: function(response){
							//response is a string --> convert into an array							
							selectedRoutineNames = response.split(',');							
							console.log("load response: ", selectedRoutineNames);
							//alert("Test");
						    },
						error: function(){
						    console.log("error");
						    }
					});

					//var el = document.getElementById("sel_"+(precision+routineName).toUpperCase());
					//el.setAttribute('name','crap');
				}
				//dojo.cookie("nameList", cookieToArray.concat(nameObj), {path: '/'});
				//console.log("cookie after drop: ", dojo.cookie("nameList"));
				//console.log("host name:", window.location.hostname);
				//console.log(location.href);
				//console.log(dojo.attr(dojo.byId(nameObj[0]), "detail"));
			}
		);

		

	});

	
	/* clear cookie */
	//function clearCookie() {
	//	dojo.cookie("nameList", null, {expire: -1});
	//}
	

	/* showing/hiding the table in the search result by clicking the image */
	function show_hide(tblid, show) {
		if (tbl == document.getElementById(tblid)) {
			if (null == show) show = tbl.style.display == 'none';
			tbl.style.display = (show ? '' : 'none');
		}
	}

	
	function HideFrame() {
		var fr = document.getElementById ("frDocViewer");
		if(fr.style.display=="none") {
		   fr.style.display="block";
		}
		else {
		   fr.style.display="none";
		}
	}

	/* disable the radiobuttons in the first question when clicking a checkbox */
	function disableRadiobuttons() {
	    length = document.frmProb.length;
	    for (i=0; i<length; i++)
		{
		    if (document.frmProb[i].type == "radio")
			document.frmProb[i].disabled = "disabled";
		}
	}



	/* disable the checkboxes in the first question when clicking a radiobutton */
	function disableCheckboxes() {
	    length = document.frmProb.length;
	    for (i=0; i<length; i++)
		{
		    if (document.frmProb[i].type == "checkbox")
			document.frmProb[i].disabled = "disabled";
		}
	}


	
	/* disable THE OTHER radiobutton in the "complex numbers" question --> NOT working yet! */
	function disableComplex(dict) {
	   length = document.frmComp.length;
	   for (i=0; i<length; i++)
		{
		    if (document.frmComp[i].value != dict)
			document.frmComp[i].disabled = "disabled";
		}
	}

	
	/* Ask for confirmation when user clicks on Restart Search button */
	function show_confirm(){
		var restart = "";
		restart = confirm("Are you sure you start over the search?");
		if(restart)
			window.location = "/search/";
		else
			return false;		
	}


	/* Clear all routines from selected routines area */
	function clearAllRoutines(){
		//reset request.session['selectedRoutines'] = [] and empty the list			
		dojo.xhrPost( {
			url: "/search/clear_session/",
			content: {clear: "all"},
			load: function(response){
				dojo.empty("sel_routineListNode");
				dojo.empty("selectedListNode");
				console.log(response);
			    },
			error: function(){
			    console.log("error");
			    }
		});
		
		//dojo.empty("routineListNode");
	}
	
	/* Eliminate duplicated elements in arrays */
	//Array.prototype.unique = function () {
	//	var r = new Array();
	//	o:for(var i = 0; i< this.length; i++)
	//	{
	//		for(var j = 0; j< r.length; j++)
	//		{
	//			if(r[j]==this[i])
	//			{
	//				//alert(r[j] +' is a DUPE!');
	//				continue o;
	//			}
	//		}
	//		r[r.length] = this[i];
	//	}
	//	return r;
	//}

	
	// Functions for faster tooltips for submit and clear buttons
	function showTooltip(id, text, color){		
		document.getElementById(id).innerHTML=text;
		document.getElementById(id).style.color=color;
	}


	// Check radio buttons in guided search, if none is selected return false, else return true
	function checkRadios(){
		var radios = document.getElementsByTagName('input');
		var checked = false;
		for (var i = 0; i < radios.length; i++) {
		    if (radios[i].type === 'radio' && radios[i].checked) {
		        checked = true;
		    }
		}
		return checked;
	}

	/*--------------------------------------------------------------------------------- */	
	/* ------------------------------ For Advanced Search ----------------------------- */
	/*--------------------------------------------------------------------------------- */
	
	// Check if at least one check box (out of three in the initial advanced search tab) has been selected 
	function validateAdvancedCategoryCheckbox(chk1, chk2, chk3){
		if (!validate3Checkbox(chk1, chk2, chk3))
		{
			alert("Select at least one category.");
			return false;
		}
		else
			return true;
	}

	// Check if at least 1/2 check box is selected
	function validate1Checkbox(cb1)
	{
		if (cb1.checked == 0)
			return false;
		else
			return true;
	}

	// Check if at least 1/2 check box is selected
	function validate2Checkbox(cb1, cb2)
	{
		if (cb1.checked == 0 && cb2.checked == 0)
			return false;
		else
			return true;
	}

	// Check if at least 1/3 check box is selected
	function validate3Checkbox(cb1, cb2, cb3)
	{
		if (cb1.checked == 0 && cb2.checked == 0 && cb3.checked == 0)
			return false;
		else
			return true;
	}

	// Check if at least 1/4 check box is selected
	function validate4Checkbox(cb1, cb2, cb3, cb4)
	{
		if (cb1.checked == 0 && cb2.checked == 0 && cb3.checked == 0 && cb4.checked == 0)
			return false;
		else
			return true;
	}

	// Check if at least 1/5 check box is selected
	function validate5Checkbox(cb1, cb2, cb3, cb4, cb5)
	{
		if (cb1.checked == 0 && cb2.checked == 0 && cb3.checked == 0 && cb4.checked == 0 && cb5.checked == 0)
			return false;
		else
			return true;
	}

	// Check if at least 1/6 check box is selected
	function validate6Checkbox(cb1, cb2, cb3, cb4, cb5, cb6)
	{
		if (cb1.checked == 0 && cb2.checked == 0 && cb3.checked == 0 && cb4.checked == 0 && cb5.checked == 0 && cb6.checked == 0)
			return false;
		else
			return true;
	}

	// Check if at least 1/7 check box is selected
	function validate7Checkbox(cb1, cb2, cb3, cb4, cb5, cb6, cb7)
	{
		if (cb1.checked == 0 && cb2.checked == 0 && cb3.checked == 0 && cb4.checked == 0 && cb5.checked == 0 && cb6.checked == 0 && cb7.checked == 0)
			return false;
		else
			return true;
	}
	

	// Check if at least one check box in each cell is selected (in Computational Routine Search)
	function validateComputationalCheckbox(f1, f2, f3, f4, f5, f6, f7, c1, c2, m1, m2, m3, m4, m5, m6, s1, s2, s3, s4, p1, p2)
	{
		f = validate7Checkbox(f1, f2, f3, f4, f5, f6, f7);
		c = validate2Checkbox(c1, c2);
		m = validate6Checkbox(m1, m2, m3, m4, m5, m6);
		s = validate4Checkbox(s1, s2, s3, s4);
		p = validate2Checkbox(p1, p2);

		if(!f)
		{
			alert("Check at least one box in the Function cell in Computational Routines column.");
			return false;
		}
		else if(!c)
		{
			alert("Check at least one box in the Complex Number cell in Computational Routines column.");
			return false;
		}
		else if(!m)
		{
			alert("Check at least one box in the Matrix Type cell in Computational Routines column.");
			return false;
		}
		else if(!s)
		{
			alert("Check at least one box in the Storage cell in Computational Routines column.");
			return false;
		}
		else if(!p)
		{
			alert("Check at least one box in the Precision cell in Computational Routines column.");
			return false;
		}
		else
			return true;
					
	}

	// Check if at least one check box in each cell is selected (in Simple Driver Routine Search)
	function validateSimpleCheckbox(f1, c1, c2, m1, m2, m3, m4, m5, s1, s2, s3, s4, p1, p2)
	{
		f = validate1Checkbox(f1);
		c = validate2Checkbox(c1, c2);
		m = validate5Checkbox(m1, m2, m3, m4, m5);
		s = validate4Checkbox(s1, s2, s3, s4);
		p = validate2Checkbox(p1, p2);

		if(!f)
		{
			alert("Check at least one box in the Function cell in Simple Driver Routines column.");
			return false;
		}
		else if(!c)
		{
			alert("Check at least one box in the Complex Number cell in Simple Driver Routines column.");
			return false;
		}
		else if(!m)
		{
			alert("Check at least one box in the Matrix Type cell in Simple Driver Routines column.");
			return false;
		}
		else if(!s)
		{
			alert("Check at least one box in the Storage cell in Simple Driver Routines column.");
			return false;
		}
		else if(!p)
		{
			alert("Check at least one box in the Precision cell in Simple Driver Routines column.");
			return false;
		}
		else
			return true;			
	}

	// Check if at least one check box in each cell is selected (in Expert Driver Routine Search)
	function validateExpertCheckbox(d1, d2, d3, f1, f2, f3, f4, c1, c2, m1, m2, m3, m4, m5, s1, s2, s3, s4, p1, p2)
	{
    	d = validate3Checkbox(d1, d2, d3);
		f = validate4Checkbox(f1, f2, f3, f4);
		c = validate2Checkbox(c1, c2);
		m = validate5Checkbox(m1, m2, m3, m4, m5);
		s = validate4Checkbox(s1, s2, s3, s4);
		p = validate2Checkbox(p1, p2);

		if(!d)
		{
			alert("Select at least one Equation in the Function cell in Expert Driver Routines column.");
			return false;
		}
		else if(!f)
		{
			alert("Select at least one Task in the Function cell in Expert Driver Routines column.");
			return false;
		}
		else if(!c)
		{
			alert("Check at least one box in the Complex Number cell in Expert Driver Routines column.");
			return false;
		}
		else if(!m)
		{
			alert("Check at least one box in the Matrix Type cell in Expert Driver Routines column.");
			return false;
		}
		else if(!s)
		{
			alert("Check at least one box in the Storage cell in Expert Driver Routines column.");
			return false;
		}
		else if(!p)
		{
			alert("Check at least one box in the Precision cell in Expert Driver Routines column.");
			return false;
		}
		else
			return true;
					
	}

	// Check if at least one check box in each cell is selected (in Computational Routine and Simple Driver Routine Search)
	function validateComputationalSimpleCheckbox(cf1, cf2, cf3, cf4, cf5, cf6, cf7, cc1, cc2, cm1, cm2, cm3, cm4, cm5, cm6, cs1, cs2, cs3, cs4, cp1, cp2, sf1, sc1, sc2, sm1, sm2, sm3, sm4, sm5, ss1, ss2, ss3, ss4, sp1, sp2)
	{
		c = validateComputationalCheckbox(cf1, cf2, cf3, cf4, cf5, cf6, cf7, cc1, cc2, cm1, cm2, cm3, cm4, cm5, cm6, cs1, cs2, cs3, cs4, cp1, cp2);

		if(c == true)
		{
			s = validateSimpleCheckbox(sf1, sc1, sc2, sm1, sm2, sm3, sm4, sm5, ss1, ss2, ss3, ss4, sp1, sp2);
		}
			

		if(c && s)
			return true;
		else 
			return false;
	}

	// Check if at least one check box in each cell is selected (in Computational Routine and Expert Driver Routine Search)
	function validateComputationalExpertCheckbox(cf1, cf2, cf3, cf4, cf5, cf6, cf7, cc1, cc2, cm1, cm2, cm3, cm4, cm5, cm6, cs1, cs2, cs3, cs4, cp1, cp2, ed1, ed2, ed3, ef1, ef2, ef3, ef4, ec1, ec2, em1, em2, em3, em4, em5, es1, es2, es3, es4, ep1, ep2)
	{
		c = validateComputationalCheckbox(cf1, cf2, cf3, cf4, cf5, cf6, cf7, cc1, cc2, cm1, cm2, cm3, cm4, cm5, cm6, cs1, cs2, cs3, cs4, cp1, cp2);	

		if(c == true)
		{
			e = validateExpertCheckbox(ed1, ed2, ed3, ef1, ef2, ef3, ef4, ec1, ec2, em1, em2, em3, em4, em5, es1, es2, es3, es4, ep1, ep2);
		}
			

		if(c && e)
			return true;
		else 
			return false;
	}

	// Check if at least one check box in each cell is selected (in Simple Driver Routine and Expert Driver Routine Search)
	function validateSimpleExpertCheckbox(sf1, sc1, sc2, sm1, sm2, sm3, sm4, sm5, ss1, ss2, ss3, ss4, sp1, sp2, ed1, ed2, ed3, ef1, ef2, ef3, ef4, ec1, ec2, em1, em2, em3, em4, em5, es1, es2, es3, es4, ep1, ep2)
	{
		s = validateSimpleCheckbox(sf1, sc1, sc2, sm1, sm2, sm3, sm4, sm5, ss1, ss2, ss3, ss4, sp1, sp2);

		if(s == true)
		{
			e = validateExpertCheckbox(ed1, ed2, ed3, ef1, ef2, ef3, ef4, ec1, ec2, em1, em2, em3, em4, em5, es1, es2, es3, es4, ep1, ep2);
		}
			

		if(s && e)
			return true;
		else 
			return false;
	}

	// Check if at least one check box in each cell is selected (in Computational Routines, Simple Driver Routine and Expert Driver Routine Search)
	function validateComputationalSimpleExpertCheckbox(cf1, cf2, cf3, cf4, cf5, cf6, cf7, cc1, cc2, cm1, cm2, cm3, cm4, cm5, cm6, cs1, cs2, cs3, cs4, cp1, cp2, sf1, sc1, sc2, sm1, sm2, sm3, sm4, sm5, ss1, ss2, ss3, ss4, sp1, sp2, ed1, ed2, ed3, ef1, ef2, ef3, ef4, ec1, ec2, em1, em2, em3, em4, em5, es1, es2, es3, es4, ep1, ep2)
	{		
		c = validateComputationalCheckbox(cf1, cf2, cf3, cf4, cf5, cf6, cf7, cc1, cc2, cm1, cm2, cm3, cm4, cm5, cm6, cs1, cs2, cs3, cs4, cp1, cp2);

		if(c == true)
		{
			s = validateSimpleCheckbox(sf1, sc1, sc2, sm1, sm2, sm3, sm4, sm5, ss1, ss2, ss3, ss4, sp1, sp2);
		}

		if(s == true)
		{
			e = validateExpertCheckbox(ed1, ed2, ed3, ef1, ef2, ef3, ef4, ec1, ec2, em1, em2, em3, em4, em5, es1, es2, es3, es4, ep1, ep2);
		}

		if(c && s && e)
			return true;
		else 
			return false;
	}


	/*--------------------------------------------------------------------------------- */	
	/* ------------------------------ For Keyword Search ----------------------------- */
	/*--------------------------------------------------------------------------------- */

	// Check if any keyword was provided
	function checkKeyword(){				
		t = document.getElementById("keyword").value;	
		if(t.length == 0){
			alert("Please enter a keyword.");
			return false;
		}
		else
			return true;		
	}

	// Not used, might need later
	function catchEnter() {
		var e = window.event;
		if (e.keyCode) code = e.keyCode;
		else if (e.which) code = e.which;

		if (code==13) {
			if(checkKeyword())
				document.forms["keyword_form"].submit();
		}
	}
	
	// Trim the leading and trailing white spaces from a string
	function trim(stringToTrim) {
		return stringToTrim.replace(/^\s+|\s+$/g,"");
	}

	// Keyword autocompletion functions
	var code;
	var tmp = -1;	
	var t = null;
	var s = null;
	var kwtbArrValue = new Array();
	var kwtbArrText = new Array();
	var org_input = "";

	document.onkeydown = function(e)
	{
		if(!e) var e = window.event;
		code = e.keyCode;
		
		tmp2 = document.forms['kw_form'].elements['sel'].length - 1;

		if(document.forms['kw_form'].elements['sel'].length == 0) tmp = -1;
		
		// it's a letter (a-z, A-Z)
		if(code >= 48 && code <= 90){
			// Save the keyword as the original input
			org_input = document.getElementById("keyword").value + String.fromCharCode(code).toLowerCase();
			
			// If shift key is pressed, don't lowercase it
			//if(window.event.shiftKey)
			//	org_input = document.getElementById("keyword").value + String.fromCharCode(code);			
		}
		// down arrow key is pressed
		if(code==40){					
			tmp = tmp + 1;
			if(tmp > tmp2) tmp = tmp2;			
			document.forms['kw_form'].elements['sel'].options[tmp].selected = true;
			product = document.forms['kw_form'].elements['sel'].options[tmp].text;   
			document.forms['kw_form'].elements['kwtb'].value = product;			
		}
		// up arrow key is pressed
		if(code==38){
			if(tmp == 0){
				document.forms['kw_form'].elements['sel'].options[0].selected = false;				
				document.forms['kw_form'].elements['kwtb'].value = org_input;
				tmp = -1;
				//document.getElementById("keyword").value = "";				
			}

			if(tmp >= 1){
				tmp = tmp - 1;
				document.forms['kw_form'].elements['sel'].options[tmp].selected = true;
				product = document.forms['kw_form'].elements['sel'].options[tmp].text;   
				document.forms['kw_form'].elements['kwtb'].value = product;				
			}			
		}
		// enter is pressed
		if(code==13){			
			document.getElementById("show").style.display='none';
		}	
	}	 
		
	function init()
	{
        //create a global reference to the text field
        t = document.getElementById("keyword");
        //create a global reference to the select menu
        s = document.getElementById("sel");
        //Make a copy of the data to loop through
        //and to restore the list if needed
        for(var i = 0; i < s.options.length; i++)
        {
        	kwtbArrValue[i] = s.options[i].value;
        	kwtbArrText[i] = s.options[i].text;
        }
    }

    function findIt(val,txt,menu,tfield)
    {
    	if(code==40||code==38||code==13)
    	{

    	}
    	else
    	{
    		if(tfield.value.length == 0){
				document.getElementById("show").style.display='none';
				
				tmp = -1;
				tmp2 = 0;
				t = null;
				s = null;
				kwtbArrValue = new Array();
				kwtbArrText = new Array();

				return;
			}

			if(tfield.value.length > 0)
			{
				document.getElementById("show").style.display='inline-block';
				var tmp = document.forms['kw_form'].elements['sel'].length;
				for(a = tmp; a >= 0; a--)
				{
					document.forms['kw_form'].elements['sel'].options[a] = null;
				}

				// List of keywords
				obj = document.forms['kw_form'].elements['sel'];				
				obj[0] = new Option('factor a matrix','0');
				obj[1] = new Option('factorization','1');
				obj[2] = new Option('condition number','2');
				obj[3] = new Option('error bounds','3');
				obj[4] = new Option('forward error bounds','4');
				obj[5] = new Option('backward error bounds','5');
				obj[6] = new Option('refine the solution','6');
				obj[7] = new Option('refinement','7');
				obj[8] = new Option('equilibrate a matrix','8');
				obj[9] = new Option('equilibration','9');
				obj[10] = new Option('invert a matrix','10');
				obj[11] = new Option('complex numbers','11');
				obj[12] = new Option('general','12');
				obj[13] = new Option('symmetric','13');
				obj[14] = new Option('SPD','14');
				obj[15] = new Option('Hermitian','15');
				obj[16] = new Option('HPD','16');
				obj[17] = new Option('triangular','17');
				obj[18] = new Option('full','18');
				obj[19] = new Option('band','19');
				obj[20] = new Option('packed','20');
				obj[21] = new Option('tridiagonal','21');
				obj[22] = new Option('single precision','22');
				obj[23] = new Option('double precision','23');


				init();
			}

			if(tfield.value.length > 0)
			{
				menu.options.length = 0;
				var reg = new RegExp("^" + tfield.value,"i");
				var op = document.createElement("option");
				var tmp = null;
				var count = 0;
				for(var i = 0; i < val.length; i++)
				{
					if(reg.test(txt[i]))
					{
						var tt = document.createTextNode(txt[i]);
						tmp = op.cloneNode(false);
						tmp.setAttribute("value",val[i]);
						tmp.appendChild(tt);
						menu.appendChild(tmp);
						count++;
					}
				}
				if(count == 1) count = 2;
				document.getElementById("sel").setAttribute('size',count);
				if(count == 0)
					document.getElementById("show").style.display='none';
			}
			else{
				restore(val,txt,menu,tfield);
			}
		}
	}

	function restore(val,txt,menu,tfield)
	{
		if(tfield.value.length < 2 && menu.options.length != val.length)
		{
			menu.options.length = 0;
			var op = document.createElement("option");
			var tmp = null;
			for(var i = 0;i < val.length;i++)
			{
				var tt = document.createTextNode(txt[i]);
				tmp = op.cloneNode(false);
				tmp.setAttribute("value",val[i]);
				tmp.appendChild(tt);
				menu.appendChild(tmp);
			}
		}
	}

	function setKeywordValue(){
		var val = document.getElementById("sel").selectedIndex;
		var text = document.getElementById("sel").options[val].innerHTML;
		document.forms['kw_form'].elements['kwtb'].value = text;
		document.getElementById("show").style.display='none';
	}

	/*--------------------------------------------------------------------------------- */	
	/* ----------------------------- For Selected Routines ---------------------------- */
	/*--------------------------------------------------------------------------------- */

	// Hide the unchecked routines from the Selected Routine area and remove them from session
	function clearUncheckedRoutines(uncheckedRoutines, selectedRoutineNames){		
		
		// Remove unchecked routines from the session
		dojo.xhrPost( {
			url: "/search/clear_session/",
			content: {clear: "unchecked"},
			load: function(response){
				console.log(response);
			    },
			error: function(){
			    console.log("error");
			    }
		});
		
		var len = uncheckedRoutines.length;

		// Hide the unchecked routines
		for(var i = 0; i < len; i++){
			routineName = uncheckedRoutines[i];
			tb = document.getElementById("tb_"+routineName.toUpperCase());		
			tb.style.display = "none";
		}		
	}

	// Checks all routines
	function checkAll(field, selectedRoutineNames, selectedRoutine_session, uncheckedRoutines){
		for (i = 0; i < field.length; i++){
			field[i].checked = true;
			if(field[i].id.indexOf("cb") != -1)
				checkChanged(field[i].id.replace(/cb_/g,""), selectedRoutineNames, selectedRoutine_session, uncheckedRoutines);			
		}			
	}

	// Unchecks all routines
	function uncheckAll(field){
		for (i = 0; i < field.length; i++){
			field[i].checked = false;
			if(field[i].id.indexOf("cb") != -1)
				checkChanged(field[i].id.replace(/cb_/g,""), selectedRoutineNames, selectedRoutine_session, uncheckedRoutines);			
		}
	}

	// Called when a checkbox is checked or unchecked
	function checkChanged(routine, selectedRoutineNames, selectedRoutine_session, uncheckedRoutines){

		var checkbox = document.getElementById("cb_"+routine);

		// If any routine was dropped than use the array "selectedRoutineNames" instead of "selectedRoutine_session"
		if(selectedRoutineNames.length > 0){
			selectedRoutine_session = selectedRoutineNames;
		}		

		var detail = checkbox.value;
		var precision = detail.split("_")[0];
		var routineName = detail.split("_")[1];
		var matrixType = detail.split("_")[2];
		var storageType = detail.split("_")[3];
		var idn = detail.split("_")[4];
		var url = detail.split("_")[5];
		var checked;

		// If routine was checked
		if(checkbox.checked == 1){
			checked = "checked";
			
			checkbox.setAttribute('checked','checked');

			// Add routine name to "selectedRoutine_session"
			if(!routineExists(routine, selectedRoutine_session))
            	selectedRoutine_session.push(routine.toLowerCase());

            // Remove routine name from "uncheckedRoutines"
            if(routineExists(routine, uncheckedRoutines)){
                var index = uncheckedRoutines.indexOf(routine.toLowerCase());
                uncheckedRoutines.splice(index, 1);                 
            }            
		}

		// If routine was unchecked
		else if(checkbox.checked == 0){
			checked = "unchecked";
			checkbox.removeAttribute('checked',0);

			// Remove routine name from "selectedRoutine_session"
			if(routineExists(routine, selectedRoutine_session)){
                var index = selectedRoutine_session.indexOf(routine.toLowerCase());
                selectedRoutine_session.splice(index, 1); 
            }

            // Add routine name to "uncheckedRoutines"
            if(!routineExists(routine, uncheckedRoutines))
            	uncheckedRoutines.push(routine.toLowerCase());
		}

		// Update session
		dojo.xhrPost( {
			url: "/search/update_session/",
			content: {
				precision: precision,
				routineName: routineName,
				matrixType: matrixType,
				storageType: storageType,
				idn: idn,
				url: url,
				checkState: checked
				},
			load: function(response){
				console.log(response);
			    },
			error: function(){
			    console.log("error");
			    }
		});
		
	}

	// Returns true if "routineName" exists in "array"
	function routineExists(routineName, array){
        routineName = routineName.toLowerCase();
        for(var i = 0; i < array.length; i++){
            if(routineName == array[i]){
    	        return true;
            }
        }
        return false;
	}

	// Called when user selects an option from the "Clear" menu (combobox)
	function clearMenuChanged(){
		var menu = document.getElementById('clearMenu');
		var selected = menu.options[menu.selectedIndex].text;
		menu.options[0].selected = true;
		if(selected == "Unchecked"){
			clearUncheckedRoutines(uncheckedRoutines, selectedRoutineNames); 
			uncheckedRoutines.length = 0;
		}			
		else if(selected == "Checked")
			alert("Not implemented yet");
		else if(selected == "All"){
			clearAllRoutines(); 
			selectedRoutineNames.length = 0; 
			selectedRoutine_session.length = 0; 
			uncheckedRoutines.length = 0;
			allRoutines_session.length = 0;
		}			
	}

	// Called when user selects an option from the "Select" menu (combobox)
	function selectMenuChanged(selectedRoutineNames, selectedRoutine_session, uncheckedRoutines){
		var menu = document.getElementById('selectMenu');
		var selected = menu.options[menu.selectedIndex].text;
		menu.options[0].selected = true;
		if(selected == "All")
			checkAll(document.droppedRoutines.routines, selectedRoutineNames, selectedRoutine_session, uncheckedRoutines);
		else if(selected == "None")
			uncheckAll(document.droppedRoutines.routines, selectedRoutineNames, selectedRoutine_session, uncheckedRoutines);
	}

	// Called when user selects an option from the "Generate Template" menu (combobox)
	function generateMenuChanged(){

		var menu = document.getElementById('generateMenu');
		var selected = menu.options[menu.selectedIndex].text;
		menu.options[0].selected = true;

		// If user reordered the routines but did not click 'Done', show this dialogue
		if(document.getElementById("movebuttons").style.display == "block"){
			alert("Click 'Done' if you are done reordering the routines.");
			return;
		}

		if(selected == "C")
			Dajaxice.Driver.createTemplate(Dajax.process, {'selectedRoutine_ajax': selectedRoutineNames, 'selectedRoutine_session': selectedRoutine_session, 'prog_language': "C"});
		else if(selected == "FORTRAN")
			Dajaxice.Driver.createTemplate(Dajax.process, {'selectedRoutine_ajax': selectedRoutineNames, 'selectedRoutine_session': selectedRoutine_session, 'prog_language': "FORTRAN"});
	}

	// Unused function
	function hoverEffect(ele){
		var x = document.getElementById("ts_"+ele);
		var col = x.style.background;
		if(col == "rgb(200, 200, 200)")
			x.style.background = "";
		else
			x.style.background = "rgb(200, 200, 200)";
	}

	// Swaps the selected routine with the routine right above it (if there's any)
	function moveup(id, routines){
		
		if(id == "") return routines;

		// Get the html element for the selected routine
		var thisRoutine = document.getElementById("sel_"+id.toUpperCase());
		var prev_routine = "";
		var prev_routine_index = -1;
		var this_routine_index = -1;

		// Find the index of this routine in the "routines" array, also save the index of the previous routine
		for(var i = 0; i < routines.length; i++){
			if(routines[i] == id.toLowerCase()){
				this_routine_index = i;
				if(i > 0){
					prev_routine = routines[i-1];
					prev_routine_index = i-1;
				}				
			}
		}		
		
		if(prev_routine != ""){ // If there is a routine above the selected routine

			// Get the html element of the previous routine
			var prevRoutine = document.getElementById("sel_"+prev_routine.toUpperCase());

			// Swap the html contents of the routines
			var temp = thisRoutine.innerHTML;	
			thisRoutine.innerHTML = prevRoutine.innerHTML;
			prevRoutine.innerHTML = temp;

			// Swap their ids
			temp = thisRoutine.id;
			thisRoutine.id = prevRoutine.id;
			prevRoutine.id = temp;

			// Swap the routines in the "routines" array
			temp = routines[this_routine_index];
			routines[this_routine_index] = routines[prev_routine_index];
			routines[prev_routine_index] = temp;
		}
		
		return routines;
	}

	// Swaps the selected routine with the routine right below it (if there's any)
	function movedown(id, routines){

		if(id == "") return routines;

		// Get the html element for the selected routine
		var thisRoutine = document.getElementById("sel_"+id);
		var next_routine = "";
		var this_routine_index = -1;
		var next_routine_index = -1;

		// Find the index of this routine in the "routines" array, also save the index of the next routine
		for(var i = 0; i < routines.length; i++){
			if(routines[i] == id.toLowerCase()){
				this_routine_index = i;				
				if(i < (routines.length - 1)){
					next_routine = routines[i+1];
					next_routine_index = i+1;
				}
			}
		}		
		
		// If there is a routine below the selected routine
		if(next_routine != ""){

			// Get the html element of the next routine
			var nextRoutine = document.getElementById("sel_"+next_routine.toUpperCase());

			// Swap the routines
			var temp = thisRoutine.innerHTML;	
			thisRoutine.innerHTML = nextRoutine.innerHTML;
			nextRoutine.innerHTML = temp;

			// Swap their ids
			temp = thisRoutine.id;
			thisRoutine.id = nextRoutine.id;
			nextRoutine.id = temp;

			// Swap the routines in the "routines" array
			temp = routines[this_routine_index];
			routines[this_routine_index] = routines[next_routine_index];
			routines[next_routine_index] = temp;
		}		

		return routines;
	}

	// Called when user clicks on the name of the routine in the selected routines area
	function selectRoutine(selectedRoutine, id){

		if(selectedRoutine != ''){ // Selected routine name is a non-empty string
			if(selectedRoutine != id){ // User did not click the same routine (id = previously selected routine)
				if(document.getElementById("tb_"+selectedRoutine))
					document.getElementById("tb_"+selectedRoutine).style.background = "";				
			}
		}

		var elem = document.getElementById("tb_"+id);
		
		// If the routine background was grey (i.e. it was selected)
		if(elem.style.background == "rgb(170, 170, 170)"){
			elem.style.background = ""; // reset the color back to "" (i.e. unselect it)
			document.getElementById("movebuttons").style.display = "none"; // hide the reordering button panel
			return "";
		}
		else{ // Routine was not selected
			elem.style.background = "rgb(170, 170, 170)"; //set the background color to grey 
			document.getElementById("movebuttons").style.display = "block"; // show the reordering button panel
			return id;
		}
	}

	// Hide the panel routine ordering 
	function closeOrderingPanel(id, allRoutines_session, selectedRoutineNames, selectedRoutine_session, uncheckedRoutines){

		// If any routine was selected, unselect that first
		if(id != ''){
			if(document.getElementById("tb_"+id))
				document.getElementById("tb_"+id).style.background = "";				
		}
		// hide the reordering button panel
		document.getElementById("movebuttons").style.display = "none";

		// If any routine was dropped than use the array "selectedRoutineNames" instead of "selectedRoutine_session" 
		if(selectedRoutineNames.length > 0)
			selectedRoutine_session = selectedRoutineNames;

		// Delete all the routines form "selectedRoutine_session"
		selectedRoutine_session.length = 0;		
		
		// Add the reordered routines back to "selectedRoutine_session"
		var j = 0;
		for(var i = 0; i < allRoutines_session.length; i++){
			if(!routineExists(allRoutines_session[i],uncheckedRoutines)){ // Add it only if it's checked
				selectedRoutine_session[j] = allRoutines_session[i];	
				j++;
			}
		}

		// Clear the session
		dojo.xhrPost( {
			url: "/search/clear_session/",
			content: {clear: "all"},
			load: function(response){
				console.log(response);
			    },
			error: function(){
			    console.log("error");
			    }
		});

		// Add back the routines to the session in the updated order
		for(var i = 0; i < allRoutines_session.length; i++){
			
			routineName = allRoutines_session[i];
			
			var checkbox = document.getElementById("cb_"+routineName.toUpperCase());			

			// Extract details
			var detail = checkbox.value;
			var precision = detail.split("_")[0];
			var routineName = detail.split("_")[1];
			var matrixType = detail.split("_")[2];
			var storageType = detail.split("_")[3];
			var idn = detail.split("_")[4];
			var url = detail.split("_")[5];
			var checked = "checked";

			if(checkbox.checked == 0)
				checked = "unchecked";

			// Update session
			dojo.xhrPost( {
			url: "/search/update_session/",
			content: {
				precision: precision,
				routineName: routineName,
				matrixType: matrixType,
				storageType: storageType,
				idn: idn,
				url: url,
				checkState: checked
				},
			load: function(response){
				console.log(response);
			    },
			error: function(){
			    console.log("error");
			    }
			});
		}

		// return the reordered array of routines
		return selectedRoutine_session;
	}

	/*--------------------------------------------------------------------------------- */	
	/* ----------------------------- For Code Template Area --------------------------- */
	/*--------------------------------------------------------------------------------- */

	// Clear code template area and remove template file from server
	function clearTemplateArea(){
		Dajaxice.Driver.removeTemplateFile(Dajax.process);
		var template = document.getElementById('div-codeTemp');
		template.innerHTML = "";	
	}

	// Check if there's any code template, allow download if template is not empty
	function checkCodeTemplate(){		
		var template = document.getElementById('div-codeTemp');
		var content = trim(template.innerHTML);
		
		if(content.length > 0)			
			window.location = '/search/download/';
	}

	// Loads code template for display, called when user clicks the "Show" button
	function loadCodeTemplate(){
		dojo.xhrPost( {
			url: "/search/load_template/",
			load: function(response){
				// Set the content of the 'codeFrame' div
				document.getElementById('codeFrame').innerHTML = response.replace(/\n/g,'<br>');
				console.log("load response: ", response);
			    },
			error: function(){
			    console.log("error");
			    }
		});
	}

	/*--------------------------------------------------------------------------------- */	
	/* --------------------------------- For Script Area ------------------------------ */
	/*--------------------------------------------------------------------------------- */

	//*--- Clear Equation & kernal name fields---*
	function clearKernalEquation(){
		dojo.empty('parameterTable');
		dojo.byId("scriptEquation").value = '';
		dojo.byId("kernalName").value = '';
	}
	
	
	
	//*--- Find the index (position) of the '=' sign ---*
	function indexEqual(a){
		for (var i=0; i<a.length; i++){
			if (a[i] == '='){
				return i;
			}
			else {
				continue;
			}
		}
	}
	
	
	//*--- Remove duplicates in an array ---*
	function removeElem(elem, pos, array) {
                        return array.indexOf(elem) == pos;
	}
	
	
	
	//*--- for Submit Equation & kernal name fields---*
	var specialWords = ['alpha', 'beta'];
		
	// arrays for in, out, inout
	var optionIn = new Array();
	var optionOut = new Array();
	var optionInOut = new Array();
	
	// arrays for scalar, vector, matrix
	var optionScalar = ["alpha", "beta", "a", "b"];
	var optionVector = ["q", , "u", "v", "w", "x", "y", "z", "q'", , "u'", "v'", "w'", "x'", "y'", "z'"];
	var optionMatrix = ["A", "B", "A'", "B'"];

	// arrParameters stores the parameters
	var arrParameters = new Array();
	
	// kernal stores the kernal name and the equation
	var kernal = [];
	
	function submitEquation(){
		positionEqual = 0;
		arrParameters = [];
		kernal = [];
		optionIn = [];
		optionOut = [];
		optionInOut = [];
		var equation = dojo.byId("scriptEquation").value;
		var kernalName = dojo.byId("kernalName").value;
		kernal.push(kernalName);
		kernal.push(equation);
		
		// find the index of '='
		positionEqual = indexEqual(equation);
		
		
		// find special words in equation and remove them from equation
		for (var i=0; i<specialWords.length; i++){
			if (equation.search(specialWords[i]) != -1){
				if (equation.indexOf(specialWords[i][0]) < positionEqual){
					optionOut.push(specialWords[i]);
				}
				else {
					optionIn.push(specialWords[i]);
				}
			equation = equation.replace(specialWords[i], "");
			}
		}
		
		
		// find the index of '='
		positionEqual = indexEqual(equation);
		
		// find 'transpose'
		patt = /.'/g
		var transposeArr = [];
		while ( (result = patt.exec(equation)) ) {
			transposeArr.push(result);
		}		

		for (var i=0; i<transposeArr.length; i++){
			if (transposeArr[i].index < positionEqual){
				optionOut.push(transposeArr[i][0]);
			}
			else {
				optionIn.push(transposeArr[i][0]);
			}
			equation = equation.replace(transposeArr[i], "");
		}
		
		
		// find the index of '='
		positionEqual = indexEqual(equation);
		
		// seperate the letters in equation
		var regexLetter = /[a-zA-Z]/;
                for (var i=0; i<equation.length; i++){
                        if (regexLetter.test(equation[i]) && i<positionEqual){
                                optionOut.push(equation[i]);                              
                        }
                        if (regexLetter.test(equation[i]) && i>positionEqual){
                                optionIn.push(equation[i]);                              
                        }	
                }
		
		
		//remove duplicates in OptionIn and OptionOut
		optionIn = optionIn.filter(removeElem);		
		optionOut = optionOut.filter(removeElem);
	
		
		// set up optionInOut
		optionIn.filter(function(element) {
			if(optionOut.indexOf(element) != -1){
			    optionInOut.push(element);
			    optionIn.splice(optionIn.indexOf(element), 1);
			    optionOut.splice(optionOut.indexOf(element), 1);
			}
		});
		
		
		// create arrParameters
		arrParameters = optionIn.concat(optionOut, optionInOut);
		console.log(arrParameters);
		
		// create drop-down lists
		dojo.empty('parameterTable');
		dojo.forEach(arrParameters, displayCallback);
	}
	
	
	function displayCallback(element, index){
		var row = dojo.create('tr', {id: "tr_"+index}, 'parameterTable');
		var cell0 = dojo.create('td', {innerHTML: element+":"}, row);
		var cell1 = dojo.create('td', {innerHTML: "<select id='select1_"+index +"\'"+"size='1'>"+
					"<option value='0'>Section...</option>"+
					"<option id='op10_"+index+"\'"+"value='0'>in</option>"+
					"<option id='op11_"+index+"\'"+"value='1'>out</option>"+
					"<option id='op12_"+index+"\'"+"value='2'>inout</option></select>"}, row);
		
		// set up the preselected value for cell1
		if (optionIn.indexOf(element) != -1){
			dojo.attr("op10_"+index, "selected", "selected");	
		}
		if (optionOut.indexOf(element) != -1){
			dojo.attr("op11_"+index, "selected", "selected");	
		}
		if (optionInOut.indexOf(element) != -1){
			dojo.attr("op12_"+index, "selected", "selected");	
		}
		
		
		var cell2 = dojo.create('td', {innerHTML:
					"<select id='select2_"+index+"\'"+
					"onchange="+"\""+"updatecombo(this.value, this.id," + index+")"+"\""+
					"size='1'>"+
					"<option value='0'>Parameter type...</option>"+
					"<option id='op20_"+index+"\'"+"value='0'>scalar</option>"+
					"<option id='op21_"+index+"\'"+"value='1'>vector</option>"+
					"<option id='op22_"+index+"\'"+"value='2'>matrix</option></select>"}, row);
		
		var cell3 = dojo.create('td', {id: "cell3"+index, innerHTML: " "}, row);
		
		// set up the preselected value for cell2
		if (optionScalar.indexOf(element) != -1){
			dojo.attr("op20_"+index, "selected", "selected");
		}
		if (optionVector.indexOf(element) != -1){
			dojo.attr("op21_"+index, "selected", "selected");
			updatecombo('1', "select2"+index, index)
		}
		if (optionMatrix.indexOf(element) != -1){
			dojo.attr("op22_"+index, "selected", "selected");
			updatecombo('2', "select2"+index, index)
		}
		
	}
	
	
	function updatecombo(option, select2Id, index){
		// element is the paramater.
		var element = select2Id.substr(7) ;
		var selections ="";
		var options = [[],
				['column', 'row'],
				['column', 'row', 'general', 'symmetric', 'Hermitian', 'SPD', 'HPD']];
		if (parseInt(option) == 0){
			dojo.empty("cell3"+index);
		}
		else {
			for (var i=0; i<options[parseInt(option)].length; i++){
				selections = selections+ "<option value="+i+">"+options[parseInt(option)][i]+"</option>";
			}
			dojo.byId("cell3"+index).innerHTML = "<select id='select3_"+index+"\'"+"\">"+selections+"</select>";
		}
	}
	
	
	
	// Called when user submits some script
	function runScript(){
		var paramProperty = {'kernalName': kernal[0], 'equation': kernal[1]};
		for (var i=0; i<arrParameters.length; i++){
			var selectId_1 = 'select1'+arrParameters[i];
			var selectId_2 = 'select2'+arrParameters[i];
			var selectId_3 = 'select3'+arrParameters[i];
			if (dojo.byId(selectId_3) != null)
				paramProperty[arrParameters[i]]=[dojo.byId(selectId_1).options[dojo.byId(selectId_1).selectedIndex].text,
								 dojo.byId(selectId_2).options[dojo.byId(selectId_2).selectedIndex].text+'\(orientation='+dojo.byId(selectId_3).options[dojo.byId(selectId_3).selectedIndex].text+'\)'];
			else
				paramProperty[arrParameters[i]]=[dojo.byId(selectId_1).options[dojo.byId(selectId_1).selectedIndex].text,
								 dojo.byId(selectId_2).options[dojo.byId(selectId_2).selectedIndex].text];		
		}
		//console.log(paramProperty);
		Dajaxice.Driver.make_mfile(Dajax.process,{'paramProperty': paramProperty})
		
		//// Get the input script
		//var scriptCode = document.getElementById('script_input').value.trim();
		//
		//// Create an AJAX request
		//dojo.xhrPost( {
		//	url: "/search/script/",
		//	// Send the input script
		//	content: { 
		//		scriptCode: scriptCode,
		//	},
		//	// Load and show the response in the output panel
		//	load: function(response){
		//		document.getElementById('script_output').value = response;
		//		console.log("load response: ", response);
		//	},
		//	error: function(){
		//	    console.log("error");
		//	}
		//});
	}

	
	
	// Called when user clicks the "Clear" button
	function clearScript(){
		//// Create an AJAX request
		//dojo.xhrPost( {
		//	url: "/search/script/",
		//	// Send an empty string as input script
		//	content: { 
		//		scriptCode: "",
		//	},
		//	load: function(response){				
		//		console.log("load response: ", response);
		//	},
		//	error: function(){
		//	    console.log("error");
		//	}
		//});

		// Replace the contents of input and output panel with empty strings
		clearKernalEquation();
		dojo.byId('script_output').value = "";
	}


</script>
